name: GitHub Pages CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
  # Add workflow_dispatch to allow manual runs
  workflow_dispatch:

# Grant GITHUB_TOKEN the necessary permissions
permissions:
  contents: read
  pages: write # Required to deploy to GitHub Pages
  id-token: write # Required for deployment

jobs:
  # JOB 1: Dedicated Build Job with all image processing steps
  build_job:
    runs-on: ubuntu-latest
    name: Build Hugo Site & Prepare Artifact
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      # 1. Install Hugo (needed before any hugo command can run)
      - name: Install Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      
      # CRITICAL STEP 1: Clean Conflicting go.mod Replace Directive
      - name: Clean Conflicting go.mod Replace Directive
        run: |
          if [ -f "go.mod" ]; then
            echo "Removing conflicting replace directives from go.mod..."
            # sed command to remove lines containing 'github.com/nicokaiser/hugo-theme-gallery/v4' AND 'replace'
            sed -i.bak '/github.com\/nicokaiser\/hugo-theme-gallery\/v4/ { /replace/d; }' go.mod
            echo "--- Cleaned go.mod ---"
            cat go.mod
            echo "----------------------"
          else
            echo "go.mod not found. Skipping clean-up."
          fi

      # 2. Resolve Hugo Modules via Vendor
      - name: Resolve Hugo Modules via Vendor
        run: hugo mod vendor

      # CRITICAL STEP 3: Convert Problematic PNGs to JPG (Now fault-tolerant and safe)
      - name: Convert Problematic PNGs to JPG
        run: |
          echo "Installing ImageMagick for image conversion..."
          sudo apt-get update && sudo apt-get install -y imagemagick

          echo "Converting all PNG files in content/ to JPG..."
          find content -type f -name "*.png" -print0 | while IFS= read -r -d $'\0' file; do
              newfile="${file%.png}.jpg"
              if ! convert "$file" "$newfile" 2> /tmp/convert_error; then
                  # If conversion fails, do NOT delete the original PNG.
                  echo "WARNING: Conversion failed for '$file'. Original PNG is preserved and will be deployed as-is."
                  cat /tmp/convert_error
                  # We use 'continue' to skip the rest of the loop for this file
                  continue 
              else
                  # Conversion succeeded, now delete the old PNG and keep the new JPG
                  rm "$file"
                  echo "Converted and replaced: $file -> $newfile"
              fi
          done
          echo "Conversion complete."

      # 3. Run the Hugo build command (FIXED BASE URL and RELATIVE LINKS)
      - name: Configure and Build Hugo Site (with relative link fix and all content)
        run: |
          # CRITICAL FIX: Injecting relative URL settings to force correct pathing.
          # Append these to config.toml before the build runs.
          echo "" >> config.toml
          echo "relativeURLs = true" >> config.toml
          echo "canonifyURLs = true" >> config.toml
          
          # Build the site using the correct base URL, and INCLUDE DRAFTS (-D) and FUTURE DATES (-F)
          hugo --gc --minify --baseURL "/${{ github.event.repository.name }}/" -D -F

      # CRITICAL STEP 5: Aggressively Optimize Images to reduce overall site size
      - name: Aggressively Optimize Images
        run: |
          echo "Aggressively optimizing JPG images in the 'public' directory (Quality 70)..."
          find public -type f -name "*.jpg" -exec mogrify -quality 70 {} \;
          echo "Optimization complete. Site size should be significantly reduced."
          
      # STEP to check final size
      - name: Calculate Site Size
        run: |
          echo "--- FINAL SITE SIZE ---"
          du -sh public
          echo "-----------------------"


      # CRITICAL STEP 4: Rename files with illegal characters (like :) before uploading the artifact
      - name: Sanitize Output Filenames
        run: |
          echo "Sanitizing filenames by replacing colons (:) with hyphens (-)..."
          find public -name '*:*' -print0 | while IFS= read -r -d $'\0' file; do
              newfile=$(echo "$file" | tr ':' '-')
              mv "$file" "$newfile"
              echo "Renamed: '$file' -> '$newfile'"
          done

      # 4. Upload the built 'public' folder as the required GitHub Pages artifact
      - name: Upload GitHub Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # The contents of the built Hugo site (your 'public' directory)
          path: public

  # JOB 2: Dedicated Deployment Job for GitHub Pages
  deploy_job:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    name: Deploy To GitHub Pages
    needs: build_job
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
